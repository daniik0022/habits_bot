Данный программный продукт представляет собой Telegram-бота для отслеживания привычек. Бот реализован на языке программирования Python с использованием фреймворка aiogram версии 3.x и базы данных SQLite для долговременного хранения данных. Основной файл проекта — main.py. В нём сосредоточена вся логика работы бота, описание структуры базы данных, обработчики команд и реализация механизма напоминаний.

В начале файла выполняется импорт стандартных библиотек asyncio, logging, sqlite3, html, а также модулей datetime для работы с датой и временем. Далее подключаются компоненты фреймворка aiogram: объекты Bot и Dispatcher, типы сообщений, фильтры команд, конструкторы клавиатур, а также типы, связанные с конечным автоматом состояний (FSM) — StatesGroup, State и FSMContext. Это позволяет реализовать диалоговый сценарий добавления привычки с несколькими шагами.

В секции настроек определяются константы API_TOKEN (токен Telegram-бота, полученный через BotFather) и DB_NAME (имя файла базы данных). Настраивается логирование через модуль logging, после чего создаются экземпляр бота Bot с указанием формата сообщений parse_mode="HTML" и диспетчер Dispatcher, который отвечает за маршрутизацию входящих событий (сообщений и callback-запросов) к соответствующим обработчикам.

Для реализации диалогового ввода привычки используется машина состояний. Определён класс AddHabitState, унаследованный от StatesGroup, содержащий два состояния: waiting_for_name (ожидание ввода названия привычки) и waiting_for_time (ожидание ввода времени напоминания). Это позволяет отделить этап ввода текста привычки от этапа ввода времени и корректно обрабатывать сообщения пользователя в зависимости от текущего шага.

Работа с базой данных вынесена в отдельный блок функций. Функция init_db() создаёт при необходимости две таблицы в базе SQLite: habits и completions. Таблица habits предназначена для хранения списка привычек и содержит следующие поля: идентификатор привычки, идентификатор пользователя Telegram, название привычки, флаг активности (признак удаления) и строковое поле reminder_time с временем ежедневного напоминания в формате ЧЧ:ММ. Таблица completions хранит отметки выполнения и содержит идентификатор записи, идентификатор привычки и дату выполнения. Для пары (habit_id, done_date) введено ограничение уникальности, что предотвращает создание дублирующих отметок за один и тот же день.

Функция add_habit записывает в таблицу habits новую привычку с привязкой к конкретному пользователю и, при необходимости, с заданным временем напоминания. Функция deactivate_habit помечает привычку как неактивную, не удаляя запись физически, что позволяет в дальнейшем сохранять историю. Функция get_habits возвращает список активных привычек пользователя, а функция get_habits_for_time выбирает все привычки, для которых время напоминания совпадает с переданным значением. Функция mark_done добавляет отметку выполнения привычки за конкретную дату в таблицу completions. Функция get_habit_streak вычисляет текущую серию подряд выполненных дней для заданной привычки, начиная от текущей даты и последовательно проверяя наличие отметок за предыдущие дни. Функция get_stats формирует агрегированную статистику по каждой активной привычке: общее количество выполнений и количество выполнений за последние семь дней.

Для удобства взаимодействия с пользователем реализована функция main_keyboard, формирующая основную клавиатуру с кнопками: «Добавить привычку», «Мои привычки», «Отметить выполнение», «Статистика» и «Удалить привычку». Это позволяет пользователю работать с ботом, не вводя текстовые команды вручную.

Далее в файле определён набор обработчиков сообщений и callback-запросов. Обработчик команды /start выводит краткое описание возможностей бота и отображает основную клавиатуру. Обработчики команды /addhabit и нажатия на кнопку «Добавить привычку» инициируют диалог добавления новой привычки: бот переводит FSM в состояние waiting_for_name и запрашивает у пользователя название. В состоянии waiting_for_name обработчик habit_name_received принимает введённое название, сохраняет его во временном состоянии и переводит FSM в состояние waiting_for_time, запрашивая время напоминания в формате ЧЧ:ММ. Обработчик habit_time_received проверяет корректность введённого времени с помощью datetime.strptime, нормализует его, а затем вызывает функцию add_habit для сохранения привычки в базе данных вместе с временем напоминания. После успешного сохранения FSM очищается, и пользователю отправляется подтверждение.

Команда /listhabits и соответствующая кнопка «Мои привычки» выводят список активных привычек пользователя с указанием времени напоминаний (если они заданы). Команда /done и кнопка «Отметить выполнение» формируют список активных привычек в виде Inline-клавиатуры; при выборе конкретной привычки срабатывает обработчик callback-запроса callback_done, который отмечает выполнение в таблице completions за текущую дату. Команда /deletehabit и кнопка «Удалить привычку» показывают список привычек с кнопками «Удалить: …», а обработчик callback_delete_habit деактивирует выбранную привычку через функцию deactivate_habit. Команда /stats и кнопка «Статистика» формируют текстовую сводку по каждой активной привычке: общее количество выполнений, количество выполнений за последние семь дней и текущий стрик (серия дней подряд).

В конце блока обработчиков определён общий fallback-обработчик для всех сообщений, которые не попали ни под один из описанных сценариев. В этом случае бот уведомляет пользователя о том, что команда не распознана, и предлагает воспользоваться кнопками или командой /start. Это делает поведение бота предсказуемым и дружелюбным для пользователя.

Отдельно реализован фоновый процесс reminders_worker. Эта асинхронная функция запускается как отдельная задача при старте бота и работает в бесконечном цикле. Каждую минуту она определяет текущее время в формате ЧЧ:ММ и запрашивает из базы данных все активные привычки, для которых время напоминания совпадает с текущим. Для каждой такой привычки бот отправляет пользователю уведомление с текстом напоминания. Таким образом реализуется ежедневная рассылка напоминаний без использования внешних планировщиков или cron-задач. В случае ошибок отправки сообщений ведётся логирование, что позволяет диагностировать проблемы.

Функция main выполняет инициализацию базы данных, запускает фоновую задачу напоминаний и затем запускает цикл обработки обновлений Telegram через dp.start_polling(bot). Вокруг запуска polling-процесса организована обработка исключений: сетевые ошибки Telegram (TelegramNetworkError) перехватываются, логируются, и после небольшой паузы выполняется повторная попытка подключения. Любые другие непредвиденные ошибки также логируются, и в случае критических ситуаций бот корректно завершает работу.

Таким образом, программный код реализует завершённый сервис для работы с привычками: диалоговое добавление привычек с указанием времени напоминаний, хранение данных в базе, ежедневные напоминания, фиксацию выполнений, вычисление статистики и серий, а также базовые операции управления (просмотр и удаление привычек). Структура кода разделяет ответственность между уровнями (настройка бота, работа с базой данных, обработчики команд, фоновый планировщик), что упрощает сопровождение и возможное расширение проекта в будущем.